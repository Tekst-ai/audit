machine:
  environment:
    MOCHA_FILE: "$CIRCLE_TEST_REPORTS/test-results.xml"
    PROJECT_NAME: retraced-staging
    CLUSTER_NAME: retraced-staging
    CLOUDSDK_COMPUTE_ZONE: us-east1-b
    # testing params for staging
    PUBLISHER_API_ENDPOINT: https://api.staging.retraced.io
    PROJECT_ID: ada4383fc84948caac138f28b131f713
    ENVIRONMENT_ID: 406e148996444214b9b5912acacb8c63
    PUBLISHER_API_KEY:  5e13bc18ecad44e08bca82ab5fce0014
    QA_INTEGRATION_VERSION: 87fb921
    # semver tags
    SEMVER_MAJOR: "1"
    SEMVER_MINOR: "1.1"
    SEMVER_PATCH: "1.1.8"

    QUAY_RELEASE_REPO: quay.io/retracedhq/api
    REPLICATED_RELEASE_REPO: registry.replicated.com/library/retraced-api
  services:
    - docker
  pre:
    - mkdir ~/.yarn-cache
  node:
    version: 8.2.0

dependencies:
  override:
    - make deps

test:
  override:
    - yarn cover-xml
    - yarn report-coverage

deployment:
  docker:
    branch: master
    owner: retracedhq
    commands:
      - sudo docker build -f deploy/Dockerfile -t quay.io/retracedhq/api:${CIRCLE_SHA1:0:7} .
      - sudo docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS quay.io
      - sudo docker push quay.io/retracedhq/api:${CIRCLE_SHA1:0:7}
      - ./deploy/deploy_k8s_using_env.sh
      - sleep 20
      - ./deploy/integration_tests_using_env.sh

  prem:
    branch: release
    owner: retracedhq
    commands:
      - sudo docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS quay.io

      - sudo docker build -f deploy/Dockerfile -t ${QUAY_RELEASE_REPO}:${CIRCLE_SHA1:0:7} .
      - sudo docker tag ${QUAY_RELEASE_REPO}:${CIRCLE_SHA1:0:7} ${QUAY_RELEASE_REPO}:${SEMVER_MAJOR}
      - sudo docker tag ${QUAY_RELEASE_REPO}:${CIRCLE_SHA1:0:7} ${QUAY_RELEASE_REPO}:${SEMVER_MINOR}
      - sudo docker tag ${QUAY_RELEASE_REPO}:${CIRCLE_SHA1:0:7} ${QUAY_RELEASE_REPO}:${SEMVER_PATCH}
      - sudo docker push ${QUAY_RELEASE_REPO}:${SEMVER_MAJOR}
      - sudo docker push ${QUAY_RELEASE_REPO}:${SEMVER_MINOR}
      - sudo docker push ${QUAY_RELEASE_REPO}:${SEMVER_PATCH}

      - sudo docker login -e $REPLICATED_LIBRARY_EMAIL -u $REPLICATED_LIBRARY_USER -p $REPLICATED_LIBRARY_PASSWORD registry.replicated.com

      - sudo docker tag ${QUAY_RELEASE_REPO}:${CIRCLE_SHA1:0:7} ${REPLICATED_RELEASE_REPO}:${CIRCLE_SHA1:0:7}
      - sudo docker tag ${REPLICATED_RELEASE_REPO}:${CIRCLE_SHA1:0:7} ${REPLICATED_RELEASE_REPO}:${SEMVER_MAJOR}
      - sudo docker tag ${REPLICATED_RELEASE_REPO}:${CIRCLE_SHA1:0:7} ${REPLICATED_RELEASE_REPO}:${SEMVER_MINOR}
      - sudo docker tag ${REPLICATED_RELEASE_REPO}:${CIRCLE_SHA1:0:7} ${REPLICATED_RELEASE_REPO}:${SEMVER_PATCH}
      - sudo docker push ${REPLICATED_RELEASE_REPO}:${SEMVER_MAJOR}
      - sudo docker push ${REPLICATED_RELEASE_REPO}:${SEMVER_MINOR}
