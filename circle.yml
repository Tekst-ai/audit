machine:
  environment:
    MOCHA_FILE: "$CIRCLE_TEST_REPORTS/test-results.xml"
    PROJECT_NAME: retraced-staging
    CLUSTER_NAME: retraced-staging
    CLOUDSDK_COMPUTE_ZONE: us-east1-b
  services:
    - docker
  pre:
    - mkdir ~/.yarn-cache
  node:
    version: 7.7.1

dependencies:
  pre:
    - npm i -g yarn
  override:
    - yarn

test:
  override:
    - yarn test
  post:
    - yarn report-coverage

deployment:
  docker:
    branch: master
    owner: retracedhq
    commands:
      - sudo docker build -f deploy/Dockerfile -t quay.io/retracedhq/api:${CIRCLE_SHA1:0:7} .
      - sudo docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS quay.io
      - sudo docker push quay.io/retracedhq/api:${CIRCLE_SHA1:0:7}
      - ./deploy/deploy_k8s_using_env.sh

