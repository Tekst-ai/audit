---
assets:
  v1:
    - github:
        repo: retracedhq/api
        path: ship/k8s
        dest: ./
        source: private
        ref: master
    - github:
        repo: retracedhq/api
        path: ship/templates
        dest: ./
        source: private
        ref: master
    - inline:
        dest: scripts/install.sh
        mode: 755
        contents: |
          #!/bin/sh
          kubectl create namespace {{repl ConfigOption "namespace"}}
          kustomize build installer/overlays/ship | kubectl apply -f -
    - inline:
        dest: scripts/test.sh
        mode: 755
        contents: |
          #!/bin/sh
          echo "tests coming soon"
    - inline:
        dest: scripts/push-images.sh
        mode: 755
        contents: |
          #!/bin/sh
          echo "loading images -- ensure your docker client is configured for authenticating to {{repl ConfigOption "docker_registry"}} and the repo '/retraced' exists"
          docker load < installer/images/retraced.tar
          docker tag quay.io/retracedhq/retraced:f5cd431 {{repl ConfigOption "docker_registry"}}/retraced:f5cd431
          docker push {{repl ConfigOption "docker_registry"}}/retraced:f5cd431

          docker load < installer/images/nsq.tar
          docker tag nsqio/nsq:v1.0.0-compat {{repl ConfigOption "docker_registry"}}/retraced:nsq-v1.0.0-compat
          docker push {{repl ConfigOption "docker_registry"}}/retraced:nsq-v1.0.0-compat

    - docker:
        dest: images/retraced.tar
        source: quay
        image: quay.io/retracedhq/retraced:f5cd431

    - docker:
        dest: images/nsq.tar
        source: public
        image: nsqio/nsq:v1.0.0-compat



lifecycle:
  v1:
    - message:
        contents: |
          Audit Log
          =========

          This tool will walk you through several steps to
          allow you to customize the installation and deploy Audit Log
          to your kubernetes cluster.

    - config: {}
    - render: {}
    - kustomize:
        base_path: "installer/ship/k8s"
        dest: installer/overlays/ship
    - message:
        contents: |
          Assets are almost ready. Fill out the file at

              ./installer/ship/templates/secrets.yaml

          and then deploy that to your cluster separately.

          Then, you can run

              ./scripts/install.sh

          To deploy the audit log to your cluster.

config:
  v1:
    - title: Basics
      name: basics
      items:
      - name: namespace
        title: Kubernetes Namespace
        help_text: "The Namespace that you'll deploy retraced into"
        type: text
        required: true
        default: 'retraced'
      - name: hostname
        title: Hostname
        type: text
        help_text: "The hostname that you will use to communicate with the retraced API"
        required: true
        default: 'http://api.{{repl ConfigOption "namespace"}}.svc.cluster.local'
      - name: docker_registry
        title: Docker Registry
        type: text
        help_text: "A docker registry that you will store the audit log docker images in. You will need to ensure the repository /retraced exists in the target registry."
        required: true
        default: 'quay.io/somebigbank'

